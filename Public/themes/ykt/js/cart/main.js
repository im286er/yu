"use strict";define(function(require,exports,module){var t,$=require("jquery"),e=require("common"),o=[],n=!0;require("artDialog"),$(function(){function a(){var t=0;$("input[name='gpid[]']").each(function(e,n){var a=$(this).prop("checked");if(a){var i=$(this).closest(".J-order-list").attr("data-gpid");o.push(i),t++}}),o.length?$.ajax({url:yktGlobal.controller+"/cal",type:"post",dataType:"json",data:{gpid:o}}).done(function(e){$("#J-total-amount").text(t),$("#J-total-price").text("￥"+e.total_price),n=!0}):($("#J-total-amount").text(0),$("#J-total-price").text("￥0"),n=!1),o=[]}function i(){$(".J-amount-input").val(t)}function l(){$("#J-sure-btn").closest("form").attr("action","/Index/Order/genernate.html").submit()}function r(){$(".ui-popup-backdrop").remove(),$(".ui-popup-show").remove();var t=[];e.appendLoading("J-html-loading"),$("input[name='gpid[]']").each(function(e,o){var n,a=$(this).prop("checked");a&&(n=$(this).closest(".J-order-list").attr("data-gpid"),t.push(n))}),$.ajax({url:"/Index/Order/merge",type:"POST",dataType:"html",data:{gpid:t}}).done(function(t){setTimeout(function(){dialog({title:"合并订单",content:t,okValue:"确定",cancelValue:"取消",fixed:!0,ok:function(){var t=$("#J-form-merge");t.html?t.submit():""},cancel:function(){}}).width(800).showModal(),e.highLight(),$("#J-html-loading").remove()},500)})}function c(t,e,o){var n=void 0,a=void 0;return t>e?(a="库存不足",n=!0):1>t?(a="商品不能少于1",n=!0):isNaN(t)?(a="请输入正确的数字",n=!0):n=!1,n?(dialog({title:"提示",content:a,okValue:"确定",fixed:!0,ok:function(){}}).width(200).showModal(),o?o():"",!1):!0}function d(){var e;$(".J-amount-input").on("focus",function(){e=$(this).val(),t=e}),$(".J-amount-input").on("change",function(){var t=$(this),o=parseInt($(this).val()),n=$(this).closest(".J-order-list"),a=n.attr("data-gpid"),l=n.find(".J-item-price .num"),r=parseInt(n.attr("data-stock"));return c(o,r,i)?void $.ajax({url:yktGlobal.controller+"/adjust",type:"POST",data:{gpid:a,num:o}}).done(function(o){o.code?(l.text(o.item_price),$("#J-total-price").text("￥"+o.total_price)):(dialog({title:"提示",content:o.msg,okValue:"确定",fixed:!0,ok:function(){}}).width(200).showModal(),t.val(e))}):!1})}function u(t,e){$(t).on("click",function(){var t=$(this).siblings(".J-amount-input"),o=$(this).closest(".J-order-list"),n=parseInt(t.val()),a=o.attr("data-gpid"),i=parseInt(o.attr("data-stock")),l=o.find(".J-item-price .num");return"increase"==e?n++:n--,c(n,i)?void $.ajax({url:yktGlobal.controller+"/"+e,type:"POST",data:{gpid:a}}).done(function(e){e.code?(t.val(n),l.text(e.item_price),$("#J-total-price").text("￥"+e.total_price)):dialog({title:"提示",content:e.msg||"数量错误",okValue:"确定",fixed:!0,ok:function(){}}).width(200).showModal()}):!1})}d(),u(".J-amount-increase","increase"),u(".J-amount-decrease","reduce"),$("#J-sure-btn").on("click",function(){if(n){var t=$(this);$.ajax({url:"/Index/Login/isLogin",async:!1,dataType:"json"}).done(function(o){o.status?t.closest("form").submit():(e.LoginDialog("/Index/Order/genernate.html",l),event.preventDefault())})}else dialog({title:"提示",content:"请勾选你需要结算的宝贝",okValue:"确定",fixed:!0,ok:function(){}}).width(200).showModal()}),$(".J-delete").on("click",function(){var t=$(this),e=$(this).parents(".J-order-list").attr("data-gpid");$.ajax({url:yktGlobal.controller+"/remove",type:"POST",data:{gpid:e}}).done(function(e){e.code?e.cart_num?(t.closest(".J-order-list").remove(),$("#J-total-price").text("￥"+e.total_price),$("#J-total-amount").text(e.cart_num)):window.location.reload():dialog({title:"提示",content:e.msg,okValue:"确定",fixed:!0,ok:function(){}}).width(200).showModal()})}),$("#J-clearAll").on("click",function(){$.ajax({url:yktGlobal.controller+"/clear"}).done(function(t){window.location.reload()})}),$("#J-merge-btn").on("click",function(){if(n){$(this);$.ajax({url:"/Index/Login/isLogin",async:!1,dataType:"json"}).done(function(t){t.status?r():(e.LoginDialog("/Index/Order/genernate.html",r),event.preventDefault())})}else dialog({title:"提示",content:"请勾选你需要结算的宝贝",okValue:"确定",fixed:!0,ok:function(){}}).width(200).showModal()}),e.selectAll("#J-checkbox-all","input[name='gpid[]']",a)})});