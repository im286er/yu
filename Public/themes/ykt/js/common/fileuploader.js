"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};define(function(require,exports,module){var $=require("jquery"),qq=qq||{};qq.extend=function(e,t){for(var o in t)e[o]=t[o]},qq.indexOf=function(e,t,o){if(e.indexOf)return e.indexOf(t,o);o=o||0;var n=e.length;for(0>o&&(o+=n);n>o;o++)if(o in e&&e[o]===t)return o;return-1},qq.getUniqueId=function(){var e=0;return function(){return e++}}(),qq.ie=function(){return-1!=navigator.userAgent.indexOf("MSIE")},qq.safari=function(){return void 0!=navigator.vendor&&-1!=navigator.vendor.indexOf("Apple")},qq.chrome=function(){return void 0!=navigator.vendor&&-1!=navigator.vendor.indexOf("Google")},qq.firefox=function(){return-1!=navigator.userAgent.indexOf("Mozilla")&&void 0!=navigator.vendor&&""==navigator.vendor},qq.windows=function(){return"Win32"==navigator.platform},qq.attach=function(e,t,o){return e.addEventListener?e.addEventListener(t,o,!1):e.attachEvent&&e.attachEvent("on"+t,o),function(){qq.detach(e,t,o)}},qq.detach=function(e,t,o){e.removeEventListener?e.removeEventListener(t,o,!1):e.attachEvent&&e.detachEvent("on"+t,o)},qq.preventDefault=function(e){e.preventDefault?e.preventDefault():e.returnValue=!1},qq.insertBefore=function(e,t){t.parentNode.insertBefore(e,t)},qq.remove=function(e){e.parentNode.removeChild(e)},qq.contains=function(e,t){return e==t?!0:e.contains?e.contains(t):!!(8&t.compareDocumentPosition(e))},qq.toElement=function(){var e=document.createElement("div");return function(t){e.innerHTML=t;var o=e.firstChild;return e.removeChild(o),o}}(),qq.css=function(e,t){null!=t.opacity&&"string"!=typeof e.style.opacity&&"undefined"!=typeof e.filters&&(t.filter="alpha(opacity="+Math.round(100*t.opacity)+")"),qq.extend(e.style,t)},qq.hasClass=function(e,t){var o=new RegExp("(^| )"+t+"( |$)");return o.test(e.className)},qq.addClass=function(e,t){qq.hasClass(e,t)||(e.className+=" "+t)},qq.removeClass=function(e,t){var o=new RegExp("(^| )"+t+"( |$)");e.className=e.className.replace(o," ").replace(/^\s+|\s+$/g,"")},qq.setText=function(e,t){e.innerText=t,e.textContent=t},qq.children=function(e){for(var t=[],o=e.firstChild;o;)1==o.nodeType&&t.push(o),o=o.nextSibling;return t},qq.getByClass=function(e,t){if(e.querySelectorAll)return e.querySelectorAll("."+t);for(var o=[],n=e.getElementsByTagName("*"),i=n.length,s=0;i>s;s++)qq.hasClass(n[s],t)&&o.push(n[s]);return o},qq.obj2url=function(e,t,o){var n=[],i="&",s=function(e,o){var i=t?/\[\]$/.test(t)?t:t+"["+o+"]":o;"undefined"!=i&&"undefined"!=o&&n.push("object"===("undefined"==typeof e?"undefined":_typeof(e))?qq.obj2url(e,i,!0):"[object Function]"===Object.prototype.toString.call(e)?encodeURIComponent(i)+"="+encodeURIComponent(e()):encodeURIComponent(i)+"="+encodeURIComponent(e))};if(!o&&t)i=/\?/.test(t)?/\?$/.test(t)?"":"&":"?",n.push(t),n.push(qq.obj2url(e));else if("[object Array]"===Object.prototype.toString.call(e)&&"undefined"!=typeof e)for(var a=0,r=e.length;r>a;++a)s(e[a],a);else if("undefined"!=typeof e&&null!==e&&"object"===("undefined"==typeof e?"undefined":_typeof(e)))for(var a in e)s(e[a],a);else n.push(encodeURIComponent(t)+"="+encodeURIComponent(e));return t?n.join(i):n.join(i).replace(/^&/,"").replace(/%20/g,"+")};var qq=qq||{};qq.FileUploaderBasic=function(e){this._options={debug:!1,action:"/server/upload",params:{},customHeaders:{},button:null,multiple:!0,maxConnections:3,disableCancelForFormUploads:!1,autoUpload:!0,forceMultipart:!1,allowedExtensions:[],acceptFiles:null,sizeLimit:0,minSizeLimit:0,stopOnFirstInvalidFile:!0,onSubmit:function(e,t){},onComplete:function(e,t,o){},onCancel:function(e,t){},onUpload:function(e,t,o){},onProgress:function(e,t,o,n){},onError:function(e,t,o){},messages:{typeError:"禁止上传该格式文件，请上传以下格式文件:\r\n {extensions}.",sizeError:"{file} 过大, 最大 {sizeLimit}.",minSizeError:"{file} 太小，最小 {minSizeLimit}.",emptyError:"{file} 为空，请重选.",noFilesError:"没有选择文件.",onLeave:"正在上传文件，如果您离开页面，上传将被取消。"},showMessage:function(e){alert(e)},inputName:"qqfile"},qq.extend(this._options,e),this._wrapCallbacks(),qq.extend(this,qq.DisposeSupport),this._filesInProgress=0,this._storedFileIds=[],this._handler=this._createUploadHandler(),this._options.button&&(this._button=this._createUploadButton(this._options.button)),this._preventLeaveInProgress()},qq.FileUploaderBasic.prototype={log:function(e){this._options.debug&&window.console&&console.log("[uploader] "+e)},setParams:function(e){this._options.params=e},getInProgress:function(){return this._filesInProgress},uploadStoredFiles:function(){for(;this._storedFileIds.length;)this._filesInProgress++,this._handler.upload(this._storedFileIds.shift(),this._options.params)},clearStoredFiles:function(){this._storedFileIds=[]},_createUploadButton:function(e){var t=this,o=new qq.UploadButton({element:e,multiple:this._options.multiple&&qq.UploadHandlerXhr.isSupported(),acceptFiles:this._options.acceptFiles,onChange:function(e){t._onInputChange(e)}});return this.addDisposer(function(){o.dispose()}),o},_createUploadHandler:function(){var e,t=this;e=qq.UploadHandlerXhr.isSupported()?"UploadHandlerXhr":"UploadHandlerForm";var o=new qq[e]({debug:this._options.debug,action:this._options.action,forceMultipart:this._options.forceMultipart,maxConnections:this._options.maxConnections,customHeaders:this._options.customHeaders,inputName:this._options.inputName,demoMode:this._options.demoMode,onProgress:function(e,o,n,i){t._onProgress(e,o,n,i),t._options.onProgress(e,o,n,i)},onComplete:function(e,o,n){t._onComplete(e,o,n),t._options.onComplete(e,o,n)},onCancel:function(e,o){t._onCancel(e,o),t._options.onCancel(e,o)},onError:t._options.onError,onUpload:function(e,o,n){t._onUpload(e,o,n),t._options.onUpload(e,o,n)}});return o},_preventLeaveInProgress:function(){var e=this;this._attach(window,"beforeunload",function(t){if(e._filesInProgress){var t=t||window.event;return t.returnValue=e._options.messages.onLeave,e._options.messages.onLeave}})},_onSubmit:function(e,t){this._options.autoUpload&&this._filesInProgress++},_onProgress:function(e,t,o,n){},_onComplete:function(e,t,o){if(this._filesInProgress--,!o.success){var n=o.error?o.error:"上传失败";this._options.onError(e,t,n)}},_onCancel:function(e,t){var o=qq.indexOf(this._storedFileIds,e);this._options.autoUpload||0>o?this._filesInProgress--:this._options.autoUpload||this._storedFileIds.splice(o,1)},_onUpload:function(e,t,o){},_onInputChange:function(e){this._handler instanceof qq.UploadHandlerXhr?this._uploadFileList(e.files):this._validateFile(e)&&this._uploadFile(e),this._button.reset()},_uploadFileList:function(e){if(e.length>0){for(var t=0;t<e.length;t++)if(this._validateFile(e[t]))this._uploadFile(e[t]);else if(this._options.stopOnFirstInvalidFile)return}else this._error("noFilesError","")},_uploadFile:function(e){var t=this._handler.add(e),o=this._handler.getName(t);this._options.onSubmit(t,o)!==!1&&(this._onSubmit(t,o),this._options.autoUpload?this._handler.upload(t,this._options.params):this._storeFileForLater(t))},_storeFileForLater:function(e){this._storedFileIds.push(e)},_validateFile:function(e){var t,o;return e.value?t=e.value.replace(/.*(\/|\\)/,""):(t=null!==e.fileName&&void 0!==e.fileName?e.fileName:e.name,o=null!==e.fileSize&&void 0!==e.fileSize?e.fileSize:e.size),this._isAllowedExtension(t)?0===o?(this._error("emptyError",t),!1):o&&this._options.sizeLimit&&o>this._options.sizeLimit?(this._error("sizeError",t),!1):o&&o<this._options.minSizeLimit?(this._error("minSizeError",t),!1):!0:(this._error("typeError",t),!1)},_error:function(e,t){function o(e,t){n=n.replace(e,t)}var n=this._options.messages[e],i=this._options.allowedExtensions.join(", ");o("{file}",this._formatFileName(t)),o("{extensions}",i),o("{sizeLimit}",this._formatSize(this._options.sizeLimit)),o("{minSizeLimit}",this._formatSize(this._options.minSizeLimit)),this._options.onError(null,t,n),this._options.showMessage(n)},_formatFileName:function(e){return e.length>33&&(e=e.slice(0,19)+"..."+e.slice(-13)),e},_isAllowedExtension:function(e){var t=-1!==e.indexOf(".")?e.replace(/.*[.]/,"").toLowerCase():"",o=this._options.allowedExtensions;if(!o.length)return!0;for(var n=0;n<o.length;n++)if(o[n].toLowerCase()==t)return!0;return!1},_formatSize:function(e){var t=-1;do e/=1024,t++;while(e>99);return Math.max(e,.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][t]},_wrapCallbacks:function(){var e,t;e=this,t=function(t,o){try{return t.apply(e,o)}catch(n){e.log("Caught "+n+" in callback: "+t)}};for(var o in this._options)/^on[A-Z]/.test(o)&&!function(){var n=e._options[o];e._options[o]=function(){return t(n,arguments)}}()}},qq.FileUploader=function(e){qq.FileUploaderBasic.apply(this,arguments),qq.extend(this._options,{element:null,listElement:null,dragText:"拖放文件上传",extraDropzones:[],hideDropzones:!0,disableDefaultDropzone:!1,uploadButtonText:"上传一个文件",cancelButtonText:"取消",failUploadText:"上传失败",template:'<div class="qq-uploader">'+(this._options.disableDefaultDropzone?"":'<div class="qq-upload-drop-area"><span>{dragText}</span></div>')+(this._options.button?"":'<div class="qq-upload-button">{uploadButtonText}</div>')+(this._options.listElement?"":'<ul class="qq-upload-list"></ul>')+"</div>",fileTemplate:'<li><div class="qq-progress-bar"></div><span class="qq-upload-spinner"></span><span class="qq-upload-finished"></span><span class="qq-upload-file"></span><span class="qq-upload-size"></span><a class="qq-upload-cancel" href="#">{cancelButtonText}</a><span class="qq-upload-failed-text">{failUploadtext}</span></li>',classes:{button:"qq-upload-button",drop:"qq-upload-drop-area",dropActive:"qq-upload-drop-area-active",dropDisabled:"qq-upload-drop-area-disabled",list:"qq-upload-list",progressBar:"qq-progress-bar",file:"qq-upload-file",spinner:"qq-upload-spinner",finished:"qq-upload-finished",size:"qq-upload-size",cancel:"qq-upload-cancel",failText:"qq-upload-failed-text",success:"qq-upload-success",fail:"qq-upload-fail",successIcon:null,failIcon:null},extraMessages:{formatProgress:"{percent}% / {total_size}",tooManyFilesError:"只能拖放一个文件"},failedUploadTextDisplay:{mode:"default",maxChars:50,responseProperty:"error",enableTooltip:!0}}),qq.extend(this._options,e),this._wrapCallbacks(),qq.extend(this._options.messages,this._options.extraMessages),this._options.template=this._options.template.replace(/\{dragText\}/g,this._options.dragText),this._options.template=this._options.template.replace(/\{uploadButtonText\}/g,this._options.uploadButtonText),this._options.fileTemplate=this._options.fileTemplate.replace(/\{cancelButtonText\}/g,this._options.cancelButtonText),this._options.fileTemplate=this._options.fileTemplate.replace(/\{failUploadtext\}/g,this._options.failUploadText),this._element=this._options.element,this._element.innerHTML=this._options.template,this._listElement=this._options.listElement||this._find(this._element,"list"),this._classes=this._options.classes,this._button||(this._button=this._createUploadButton(this._find(this._element,"button"))),this._bindCancelEvent(),this._setupDragDrop()},qq.extend(qq.FileUploader.prototype,qq.FileUploaderBasic.prototype),qq.extend(qq.FileUploader.prototype,{clearStoredFiles:function(){qq.FileUploaderBasic.prototype.clearStoredFiles.apply(this,arguments),this._listElement.innerHTML=""},addExtraDropzone:function(e){this._setupExtraDropzone(e)},removeExtraDropzone:function(e){var t=this._options.extraDropzones;for(var o in t)if(t[o]===e)return this._options.extraDropzones.splice(o,1)},_leaving_document_out:function(e){return(qq.chrome()||qq.safari()&&qq.windows())&&0==e.clientX&&0==e.clientY||qq.firefox()&&!e.relatedTarget},_storeFileForLater:function(e){qq.FileUploaderBasic.prototype._storeFileForLater.apply(this,arguments);var t=this._getItemByFileId(e);this._find(t,"spinner").style.display="none"},_find:function(e,t){var o=qq.getByClass(e,this._options.classes[t])[0];if(!o)throw new Error("元素未找到 "+t);return o},_setupExtraDropzone:function(e){this._options.extraDropzones.push(e),this._setupDropzone(e)},_setupDropzone:function(e){var t=this,o=new qq.UploadDropZone({element:e,onEnter:function(o){qq.addClass(e,t._classes.dropActive),o.stopPropagation()},onLeave:function(e){},onLeaveNotDescendants:function(o){qq.removeClass(e,t._classes.dropActive)},onDrop:function(o){t._options.hideDropzones&&(e.style.display="none"),qq.removeClass(e,t._classes.dropActive),o.dataTransfer.files.length>1&&!t._options.multiple?t._error("tooManyFilesError",""):t._uploadFileList(o.dataTransfer.files)}});this.addDisposer(function(){o.dispose()}),this._options.hideDropzones&&(e.style.display="none")},_setupDragDrop:function(){var e=this;if(!this._options.disableDefaultDropzone){var t=this._find(this._element,"drop");this._options.extraDropzones.push(t)}var o,n=this._options.extraDropzones;for(o=0;o<n.length;o++)this._setupDropzone(n[o]);this._options.disableDefaultDropzone||qq.ie()||this._attach(document,"dragenter",function(i){if(!qq.hasClass(t,e._classes.dropDisabled))for(t.style.display="block",o=0;o<n.length;o++)n[o].style.display="block"}),this._attach(document,"dragleave",function(t){if(e._options.hideDropzones&&qq.FileUploader.prototype._leaving_document_out(t))for(o=0;o<n.length;o++)n[o].style.display="none"}),qq.attach(document,"drop",function(t){if(e._options.hideDropzones)for(o=0;o<n.length;o++)n[o].style.display="none";t.preventDefault()})},_onSubmit:function(e,t){qq.FileUploaderBasic.prototype._onSubmit.apply(this,arguments),this._addToList(e,t)},_onProgress:function(e,t,o,n){qq.FileUploaderBasic.prototype._onProgress.apply(this,arguments);var i=this._getItemByFileId(e);if(o===n){var s=this._find(i,"cancel");s.style.display="none"}var a=this._find(i,"size");a.style.display="inline";var r,l=Math.round(o/n*100);r=o!=n?this._formatProgress(o,n):this._formatSize(n),this._find(i,"progressBar").style.width=l+"%",qq.setText(a,r)},_onComplete:function(e,t,o){qq.FileUploaderBasic.prototype._onComplete.apply(this,arguments);var n=this._getItemByFileId(e);qq.remove(this._find(n,"progressBar")),this._options.disableCancelForFormUploads&&!qq.UploadHandlerXhr.isSupported()||qq.remove(this._find(n,"cancel")),qq.remove(this._find(n,"spinner")),o.success?(qq.addClass(n,this._classes.success),this._classes.successIcon&&(this._find(n,"finished").style.display="inline-block",qq.addClass(n,this._classes.successIcon))):(qq.addClass(n,this._classes.fail),this._classes.failIcon&&(this._find(n,"finished").style.display="inline-block",qq.addClass(n,this._classes.failIcon)),this._controlFailureTextDisplay(n,o))},_onUpload:function(e,t,o){qq.FileUploaderBasic.prototype._onUpload.apply(this,arguments);var n=this._getItemByFileId(e);qq.UploadHandlerXhr.isSupported()&&(this._find(n,"progressBar").style.display="block");var i=this._find(n,"spinner");"none"==i.style.display&&(i.style.display="inline-block")},_addToList:function(e,t){var o=qq.toElement(this._options.fileTemplate);if(this._options.disableCancelForFormUploads&&!qq.UploadHandlerXhr.isSupported()){var n=this._find(o,"cancel");qq.remove(n)}o.qqFileId=e;var i=this._find(o,"file");qq.setText(i,this._formatFileName(t)),this._find(o,"size").style.display="none",this._options.multiple||this._clearList(),this._listElement.appendChild(o)},_clearList:function(){this._listElement.innerHTML="",this.clearStoredFiles()},_getItemByFileId:function(e){for(var t=this._listElement.firstChild;t;){if(t.qqFileId==e)return t;t=t.nextSibling}},_bindCancelEvent:function(){var e=this,t=this._listElement;this._attach(t,"click",function(t){t=t||window.event;var o=t.target||t.srcElement;if(qq.hasClass(o,e._classes.cancel)){qq.preventDefault(t);for(var n=o.parentNode;void 0==n.qqFileId;)n=o=o.parentNode;e._handler.cancel(n.qqFileId),qq.remove(n)}})},_formatProgress:function(e,t){function o(e,t){n=n.replace(e,t)}var n=this._options.messages.formatProgress;return o("{percent}",Math.round(e/t*100)),o("{total_size}",this._formatSize(t)),n},_controlFailureTextDisplay:function(e,t){var o,n,i,s,a;if(o=this._options.failedUploadTextDisplay.mode,n=this._options.failedUploadTextDisplay.maxChars,i=this._options.failedUploadTextDisplay.responseProperty,"custom"===o){var s=t[i];s?(s.length>n&&(a=s.substring(0,n)+"..."),qq.setText(this._find(e,"failText"),a||s),this._options.failedUploadTextDisplay.enableTooltip&&this._showTooltip(e,s)):this.log("'"+i+"' 服务器输出格式不正确")}else"none"===o?qq.remove(this._find(e,"failText")):"default"!==o&&this.log("failedUploadTextDisplay.mode 的值  '"+o+"' 不可用")},_showTooltip:function(e,t){e.title=t}}),qq.UploadDropZone=function(e){this._options={element:null,onEnter:function(e){},onLeave:function(e){},onLeaveNotDescendants:function(e){},onDrop:function(e){}},qq.extend(this._options,e),qq.extend(this,qq.DisposeSupport),this._element=this._options.element,this._disableDropOutside(),this._attachEvents()},qq.UploadDropZone.prototype={_dragover_should_be_canceled:function(){return qq.safari()||qq.firefox()&&qq.windows()},_disableDropOutside:function(e){qq.UploadDropZone.dropOutsideDisabled||(this._dragover_should_be_canceled?qq.attach(document,"dragover",function(e){e.preventDefault()}):qq.attach(document,"dragover",function(e){e.dataTransfer&&(e.dataTransfer.dropEffect="none",e.preventDefault())}),qq.UploadDropZone.dropOutsideDisabled=!0)},_attachEvents:function(){var e=this;e._attach(e._element,"dragover",function(t){if(e._isValidFileDrag(t)){var o=qq.ie()?null:t.dataTransfer.effectAllowed;"move"==o||"linkMove"==o?t.dataTransfer.dropEffect="move":t.dataTransfer.dropEffect="copy",t.stopPropagation(),t.preventDefault()}}),e._attach(e._element,"dragenter",function(t){e._isValidFileDrag(t)&&e._options.onEnter(t)}),e._attach(e._element,"dragleave",function(t){if(e._isValidFileDrag(t)){e._options.onLeave(t);var o=document.elementFromPoint(t.clientX,t.clientY);qq.contains(this,o)||e._options.onLeaveNotDescendants(t)}}),e._attach(e._element,"drop",function(t){e._isValidFileDrag(t)&&(t.preventDefault(),e._options.onDrop(t))})},_isValidFileDrag:function(e){if(qq.ie())return!1;var t=e.dataTransfer,o=qq.safari();return t&&"none"!=t.effectAllowed&&(t.files||!o&&t.types.contains&&t.types.contains("Files"))}},qq.UploadButton=function(e){this._options={element:null,multiple:!1,acceptFiles:null,name:"file",onChange:function(e){},hoverClass:"qq-upload-button-hover",focusClass:"qq-upload-button-focus"},qq.extend(this._options,e),qq.extend(this,qq.DisposeSupport),this._element=this._options.element,qq.css(this._element,{position:"relative",overflow:"hidden",direction:"ltr"}),this._input=this._createInput()},qq.UploadButton.prototype={getInput:function(){return this._input},reset:function(){this._input.parentNode&&qq.remove(this._input),qq.removeClass(this._element,this._options.focusClass),this._input=this._createInput()},_createInput:function(){var e=document.createElement("input");this._options.multiple&&e.setAttribute("multiple","multiple"),this._options.acceptFiles&&e.setAttribute("accept",this._options.acceptFiles),e.setAttribute("type","file"),e.setAttribute("name",this._options.name),qq.css(e,{position:"absolute",right:0,top:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,cursor:"pointer",opacity:0}),this._element.appendChild(e);var t=this;return this._attach(e,"change",function(){t._options.onChange(e)}),this._attach(e,"mouseover",function(){qq.addClass(t._element,t._options.hoverClass)}),this._attach(e,"mouseout",function(){qq.removeClass(t._element,t._options.hoverClass)}),this._attach(e,"focus",function(){qq.addClass(t._element,t._options.focusClass)}),this._attach(e,"blur",function(){qq.removeClass(t._element,t._options.focusClass)}),window.attachEvent&&e.setAttribute("tabIndex","-1"),e}},qq.UploadHandlerAbstract=function(e){this._options={debug:!1,action:"/upload.php",maxConnections:999,onProgress:function(e,t,o,n){},onComplete:function(e,t,o){},onCancel:function(e,t){},onUpload:function(e,t,o){}},qq.extend(this._options,e),this._queue=[],this._params=[]},qq.UploadHandlerAbstract.prototype={log:function(e){this._options.debug&&window.console&&console.log("[uploader] "+e)},add:function(e){},upload:function(e,t){var o=this._queue.push(e),n={};qq.extend(n,t),this._params[e]=n,o<=this._options.maxConnections&&this._upload(e,this._params[e])},cancel:function(e){this._cancel(e),this._dequeue(e)},cancelAll:function(){for(var e=0;e<this._queue.length;e++)this._cancel(this._queue[e]);this._queue=[]},getName:function(e){},getSize:function(e){},getQueue:function(){return this._queue},_upload:function(e){},_cancel:function(e){},_dequeue:function(e){var t=qq.indexOf(this._queue,e);this._queue.splice(t,1);var o=this._options.maxConnections;if(this._queue.length>=o&&o>t){var n=this._queue[o-1];this._upload(n,this._params[n])}}},qq.UploadHandlerForm=function(e){qq.UploadHandlerAbstract.apply(this,arguments),this._inputs={},this._detach_load_events={}},qq.extend(qq.UploadHandlerForm.prototype,qq.UploadHandlerAbstract.prototype),qq.extend(qq.UploadHandlerForm.prototype,{add:function(e){e.setAttribute("name",this._options.inputName);var t="qq-upload-handler-iframe"+qq.getUniqueId();return this._inputs[t]=e,e.parentNode&&qq.remove(e),t},getName:function(e){return this._inputs[e].value.replace(/.*(\/|\\)/,"")},_cancel:function(e){this._options.onCancel(e,this.getName(e)),delete this._inputs[e],delete this._detach_load_events[e];var t=document.getElementById(e);t&&(t.setAttribute("src","javascript:false;"),qq.remove(t))},_upload:function(e,t){this._options.onUpload(e,this.getName(e),!1);var o=this._inputs[e];if(!o)throw new Error("上传失败");var n=this.getName(e);t[this._options.inputName]=n;var i=this._createIframe(e),s=this._createForm(i,t);s.appendChild(o);var a=this;return this._attachLoadEvent(i,function(){a.log("iframe loaded");var t=a._getIframeContentJSON(i);a._options.onComplete(e,n,t),a._dequeue(e),delete a._inputs[e],setTimeout(function(){a._detach_load_events[e](),delete a._detach_load_events[e],qq.remove(i)},1)}),s.submit(),qq.remove(s),e},_attachLoadEvent:function(e,t){this._detach_load_events[e.id]=qq.attach(e,"load",function(){if(e.parentNode){try{if(e.contentDocument&&e.contentDocument.body&&"false"==e.contentDocument.body.innerHTML)return}catch(o){}t()}})},_getIframeContentJSON:function _getIframeContentJSON(iframe){try{var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response,innerHTML=doc.body.innerHTML;this.log("converting iframe's innerHTML to JSON"),this.log("innerHTML = "+innerHTML),"<pre>"==innerHTML.slice(0,5).toLowerCase()&&"</pre>"==innerHTML.slice(-6).toLowerCase()&&(innerHTML=doc.body.firstChild.firstChild.nodeValue),response=eval("("+innerHTML+")")}catch(err){response={success:!1}}return response},_createIframe:function(e){var t=qq.toElement('<iframe src="javascript:false;" name="'+e+'" />');return t.setAttribute("id",e),t.style.display="none",document.body.appendChild(t),t},_createForm:function(e,t){var o=this._options.demoMode?"GET":"POST",n=qq.toElement('<form method="'+o+'" enctype="multipart/form-data"></form>'),i=qq.obj2url(t,this._options.action);return n.setAttribute("action",i),n.setAttribute("target",e.name),n.style.display="none",document.body.appendChild(n),n}}),qq.UploadHandlerXhr=function(e){qq.UploadHandlerAbstract.apply(this,arguments),this._files=[],this._xhrs=[],this._loaded=[]},qq.UploadHandlerXhr.isSupported=function(){var e=document.createElement("input");return e.type="file","multiple"in e&&"undefined"!=typeof File&&"undefined"!=typeof FormData&&"undefined"!=typeof(new XMLHttpRequest).upload},qq.extend(qq.UploadHandlerXhr.prototype,qq.UploadHandlerAbstract.prototype),qq.extend(qq.UploadHandlerXhr.prototype,{add:function(e){if(!(e instanceof File))throw new Error("上传失败，传送的数据对象不是文件 (qq.UploadHandlerXhr)");return this._files.push(e)-1},getName:function(e){var t=this._files[e];return null!==t.fileName&&void 0!==t.fileName?t.fileName:t.name},getSize:function(e){var t=this._files[e];return null!=t.fileSize?t.fileSize:t.size},getLoaded:function(e){return this._loaded[e]||0},_upload:function(e,t){this._options.onUpload(e,this.getName(e),!0);var o=this._files[e],n=this.getName(e);this.getSize(e);this._loaded[e]=0;var i=this._xhrs[e]=new XMLHttpRequest,s=this;i.upload.onprogress=function(t){t.lengthComputable&&(s._loaded[e]=t.loaded,s._options.onProgress(e,n,t.loaded,t.total))},i.onreadystatechange=function(){4==i.readyState&&s._onComplete(e,i)},t=t||{},t[this._options.inputName]=n;var a=qq.obj2url(t,this._options.action),r=this._options.demoMode?"GET":"POST";if(i.open(r,a,!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.setRequestHeader("X-File-Name",encodeURIComponent(n)),i.setRequestHeader("Cache-Control","no-cache"),this._options.forceMultipart){var l=new FormData;l.append(this._options.inputName,o),o=l}else i.setRequestHeader("Content-Type","application/octet-stream"),i.setRequestHeader("X-Mime-Type",o.type);for(key in this._options.customHeaders)i.setRequestHeader(key,this._options.customHeaders[key]);i.send(o)},_onComplete:function _onComplete(id,xhr){if(this._files[id]){var name=this.getName(id),size=this.getSize(id),response;this._options.onProgress(id,name,size,size),this.log("xhr - server response received"),this.log("responseText = "+xhr.responseText);try{response="function"==typeof JSON.parse?JSON.parse(xhr.responseText):eval("("+xhr.responseText+")")}catch(err){response={}}200!==xhr.status&&this._options.onError(id,name,"XHR returned response code "+xhr.status),this._options.onComplete(id,name,response),this._xhrs[id]=null,this._dequeue(id)}},_cancel:function(e){this._options.onCancel(e,this.getName(e)),this._files[e]=null,this._xhrs[e]&&(this._xhrs[e].abort(),this._xhrs[e]=null)}}),qq.DisposeSupport={_disposers:[],dispose:function(){for(var e;e=this._disposers.shift();)e()},addDisposer:function(e){this._disposers.push(e)},_attach:function(){this.addDisposer(qq.attach.apply(this,arguments))}},module.exports=qq});