"use strict";define(function(require,exports,module){function e(e,d,s){t.appendLoading("J-html-loading");var i,n="";"add"==d?(n=addAddressUrl,i="新增收货人信息"):"update"==d&&(n=editAddressUrl,i="编辑收货人信息"),$.ajax({url:n,type:"POST",dataType:"html"}).done(function(t){setTimeout(function(){function n(e,a,t){$.ajax({type:"post",dataType:"json",data:{pid:a},url:"/Index/Address/subArea",success:function(a){a?(e.empty(),e.show(),$.each(a,function(a,t){l="<option value="+t.id+">"+t.areaname+"</option>",$(l).appendTo(e)}),"1"==t&&(p=r.children("option:selected").val(),n(c,p))):(t="1")?(r.hide(),c.hide()):e.hide()}})}dialog({skin:"consignee-style",title:i,content:t,okValue:"保存收货人信息",fixed:!0,ok:function(){function t(){return $("#J-consignee-form").validate({errorPlacement:function(e,a){e.appendTo(a.siblings(".msg-span"))}}).form()}if(!t())return!1;var i=$('input[name="realname"]').val(),n=$("#J-ajax-province").children("option:selected").val(),l=$("#J-ajax-city").children("option:selected").val(),o=$("#J-ajax-area").children("option:selected").val(),r=$("#J-ajax-province").children("option:selected").text(),c=$("#J-ajax-city").children("option:selected").text(),p=$("#J-ajax-area").children("option:selected").text(),u=$('input[name="street"]').val(),h=$('input[name="mobile"]').val(),f=$('#J-consignee-form input[name="__hash__"]').val(),m=$('input[name="id"]').val();$.ajax({url:e,type:"post",dataType:"json",data:{id:m,realname:i,province:n,city:l,district:o,street:u,mobile:h,__hash__:f}}).done(function(e){var t=$(".J-addr-list").length+1,n=e.id;"add"==d?($(".consignee-item").removeClass("selected"),1==t&&$("#J-consignee").empty(),$(".J-addr-list").removeClass("selected"),$("#J-consignee").append('<li class="J-addr-list selected" data-id="'+e.id+'"><div class="consignee-item"><span data-consignee="'+r+" "+i+'">'+i+" "+r+'</span> <i></i></div><div class="addr-detail"><span class="addr-name">'+i+'</span> <span class="addr-info">'+r+" "+c+" "+p+" "+u+'</span> <span class="addr-tel">'+h+'</span></div><div class="op-btns"><a class="J-setdefault" href="javascript:;" data-id='+e.id+'>设为默认地址</a><a class="J-consignee-edit" href="javascript:;" data-id='+e.id+'>编辑</a> <a class="J-consignee-delete" href="javascript:;" data-id='+e.id+">删除</a></div></li>"),$('input[name="address_id"]').val(e.id),1==t&&($(".J-addr-list").addClass("selected setDefault"),$(".consignee-item span").text("默认地址"),a()),$('input[name="address_id"]').val(n),a()):"update"==d&&(s.closest(".J-addr-list").find(".consignee-item span").html(r+" "+i),s.closest(".J-addr-list").find(".addr-name").html(i),s.closest(".J-addr-list").find(".addr-info").html(r+" "+c+" "+p+" "+u),s.closest(".J-addr-list").find(".addr-tel").html(h),a())})}}).width(670).showModal();var l,o=$("#J-ajax-province"),r=$("#J-ajax-city"),c=$("#J-ajax-area"),p=(o.children("option:selected").val(),r.children("option:selected").val());o.change(function(){var e=$(this).children("option:selected").val();n(r,e,"1")}),r.change(function(){var e=$(this).children("option:selected").val();n(c,e)}),$("#J-html-loading").remove()},500)})}function a(){var e=$('input[name="address_id"]').val();e&&$.ajax({url:"/Index/Order/getExpressFee",type:"POST",data:{address_id:e,tcId:d}}).done(function(e){if(e.code)$("#J-expressage").text(e.express_fee),$("#J-total-price").text(e.order_price);else{var a=parseFloat($("#J-goods-price").text()),t=(parseFloat(e.cost)+a).toFixed(1);$("#J-expressage").text(e.cost),$("#J-total-price").text(t)}})}var $=require("jquery"),t=require("common");if(require("artDialog"),require("validate"),"info"==yktGlobal.pageName){var d=$('input[name="tcId"]').val();$("#J-address-wrap").delegate(".consignee-item","click",function(){var e=$(this).closest(".J-addr-list").attr("data-id");$('input[name="address_id"]').val(e),$(".J-addr-list").removeClass("selected"),$(this).closest(".J-addr-list").addClass("selected"),a()}),$("#J-address-wrap").delegate(".J-setdefault","click",function(){var e=$(this),a=$(this).attr("data-id");$.ajax({type:"POST",url:"/Index/Address/setDefault",data:{id:a}}).done(function(){$(".J-addr-list").each(function(e,a){var t=$(this).hasClass("setDefault"),d=$(this).find(".consignee-item span");if(t){var s=d.attr("data-consignee");d.html(s),$(this).removeClass("setDefault")}}),e.closest(".J-addr-list").find(".consignee-item span").html("默认地址"),e.closest(".J-addr-list").addClass("setDefault")})}),$("#J-address-wrap").delegate("#J-add-btn","click",function(){var a=$(".J-addr-list").length+1,t=$(this);5>=a?e("/Index/Address/insert","add",t):dialog({title:"提示",content:"最多可创建5个",okValue:"确定",fixed:!0,ok:function(){}}).width(200).showModal()}),$("#J-address-wrap").delegate(".J-consignee-edit","click",function(){var a=$(this),t=$(this).closest("li").attr("data-id");editAddressUrl="/Index/Address/edit/id/",editAddressUrl+=t,e("/Index/Address/update","update",a)}),$("#J-address-wrap").delegate(".J-consignee-delete","click",function(){var e=$(this),a=$(this).attr("data-id");$.ajax({url:"/Index/Address/del",data:{id:a}}).done(function(a){var t=e.closest(".J-addr-list").hasClass("selected");$("#J-goods-price").text();t&&$.ajax({url:"/Index/order/clearExpressFee",data:{tcId:d}}).done(function(e){e.code&&($("#J-expressage").text(""),$("#J-total-price").text(e.order_price),$('input[name="address_id"]').val(""))});var s=$(".J-addr-list").length;1>=s&&$("#J-consignee").append('<h3 class="fl" style="color: red;">未有收货人信息!</h3>'),e.closest(".J-addr-list").remove()})}),a(),$("#J-submit-btn").on("click",function(){var e=$('input[name="address_id"]').val(),a=$('input[name="__hash__"]').val(),t="亲爱的会员~~,订单信息失效或商品库存限制,请重新选取商品下单!";return e?($(this).off("click").removeClass("u-btn-primary").addClass("u-disabled").text("提交中..."),void $.ajax({url:"/Index/Order/submit",type:"POST",dataType:"json",data:{tcId:d,__hash__:a,address_id:e}}).done(function(e){return e.code?(window.location.href=e.jumpUrl,!1):(e.msg&&(t=e.msg),void dialog({title:"消息",content:t,okValue:"确定",fixed:!0,cancel:!1,ok:function(){window.location.href="/Index/Sale/index.html"}}).width(500).showModal())})):(dialog({title:"消息",content:"请选择收货人!",okValue:"确定",fixed:!0,ok:function(){}}).width(400).showModal(),!1)})}else"confirm"==yktGlobal.pageName&&$('input[type="button"]').on("click",function(){$(this).off("click").removeClass("u-btn-primary").addClass("u-disabled").text("提交中..."),dialog({title:"正在支付...",content:'<a class="dialog-btn" href="/Index/Home/index.html">支付已完成!</a><a class="dialog-btn" href="/Index/Home/index.html">支付出现问题?</a>',okValue:"确定",fixed:!0,cancel:!1,ok:!1}).width(300).showModal(),$(this).closest("form").submit()})});